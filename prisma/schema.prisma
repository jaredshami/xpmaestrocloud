// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Admin {
  id        Int     @id @default(autoincrement())
  email     String  @unique
  passwordHash String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("admins")
}

model Client {
  id          Int       @id @default(autoincrement())
  customerId  Int       @unique
  name        String
  email       String    @unique
  phone       String?
  company     String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  instances   Instance[]

  @@map("clients")
}

model Instance {
  id          Int       @id @default(autoincrement())
  clientId    Int
  customerId  Int
  instanceId  Int
  subdomain   String    @unique
  folderPath  String
  environment String    // prod, stage, dev
  status      String    @default("active") // active, inactive, suspended
  coreVersion String    @default("latest") // Current core version (e.g., v1.0, v1.1)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  client      Client    @relation(fields: [clientId], references: [id], onDelete: Cascade)
  users       InstanceUser[]
  versionHistory VersionHistory[]

  @@map("instances")
  @@index([clientId])
  @@index([customerId])
}

model InstanceUser {
  id          Int       @id @default(autoincrement())
  instanceId  Int
  email       String
  name        String?
  passwordHash String?
  role        String    @default("editor") // admin, editor, viewer
  status      String    @default("active") // active, inactive, pending
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relations
  instance    Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@unique([instanceId, email])
  @@map("instance_users")
}

model VersionHistory {
  id            Int       @id @default(autoincrement())
  instanceId    Int
  fromVersion   String    // Previous version
  toVersion     String    // New version
  status        String    @default("completed") // pending, completed, failed, rolled_back
  notes         String?
  createdAt     DateTime  @default(now())
  completedAt   DateTime?

  // Relations
  instance      Instance  @relation(fields: [instanceId], references: [id], onDelete: Cascade)

  @@map("version_history")
  @@index([instanceId])
}
